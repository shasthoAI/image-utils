<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Utils</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --bg: #f7f8fa;
            --card: #ffffff;
            --muted: #6b7280;
            --text: #111827;
            --primary: #3b82f6;
            --primary-600: #2563eb;
            --border: #e5e7eb;
            --success: #16a34a;
            --danger: #dc2626;
            --shadow: 0 6px 18px rgba(0,0,0,0.06);
        }
        
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
            -webkit-font-smoothing: antialiased;
        }
        
        .container { max-width: 1200px; margin: 0 auto; background: var(--card); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
        
        .header { background: var(--card); color: var(--text); padding: 24px 28px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        
        .header h1 { font-size: 1.5rem; margin: 0; font-weight: 700; letter-spacing: -0.01em; }
        
        .header p { display:none; }
        
        .nav-tabs { display:flex; background: var(--card); border-bottom: 1px solid var(--border); }
        
        .nav-tab { flex:1; padding:14px 16px; text-align:center; background:none; border:none; font-size:0.95rem; font-weight:600; cursor:pointer; transition: all .2s ease; border-bottom:2px solid transparent; color: var(--muted); }
        
        .nav-tab:hover { background:#fafafa; color: var(--text); }
        
        .nav-tab.active { background: var(--card); border-bottom-color: var(--primary); color: var(--primary); }
        
        .content { padding: 28px 32px; }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area { border:2px dashed var(--border); border-radius:12px; padding:40px 28px; text-align:center; margin-bottom:20px; transition: all .2s ease; cursor:pointer; background:#fff; }
        
        .upload-area:hover { border-color: var(--primary); background:#f9fafb; }
        
        .upload-area.dragover { border-color: var(--primary); background:#eef6ff; transform: scale(1.01); }
        
        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input {
            width: auto;
        }
        
        .btn { display:inline-block; padding:10px 16px; border-radius:8px; border:1px solid var(--border); background:#fff; font-size:0.95rem; font-weight:600; cursor:pointer; transition: transform .06s ease, box-shadow .15s ease, background .15s ease; }
        
        .btn-primary { background: var(--primary); border-color: var(--primary); color:#fff; }
        
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(59,130,246,0.25); background: var(--primary-600); }
        
        .btn-secondary { background:#fff; color: var(--text); }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-list {
            margin: 20px 0;
        }
        
        .file-item { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#fff; border:1px solid var(--border); border-radius:10px; margin-bottom:10px; }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .file-size {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .results {
            margin-top: 30px;
        }
        
        .result-item { padding:18px; background:#fff; border:1px solid var(--border); border-radius:12px; margin-bottom:14px; box-shadow: var(--shadow); }
        
        .result-success { border-left: 4px solid var(--success); }
        
        .result-error { border-left: 4px solid var(--danger); }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .jobs-list {
            margin-top: 20px;
        }
        
        .job-item { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#fff; border:1px solid var(--border); border-radius:10px; margin-bottom:12px; cursor:pointer; transition: background .1s ease; }
        
        .job-item:hover { background:#f8fafc; }
        
        .job-info h4 {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .job-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .job-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chain-builder {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chain-step {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .remove-step {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .add-step {
            width: 100%;
            padding: 15px;
            border: 2px dashed #667eea;
            background: none;
            border-radius: 8px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
        }
        
        .add-step:hover {
            background: #f8f9ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .download-links {
            margin-top: 15px;
        }
        
        .download-link { display:inline-block; margin-right:8px; margin-bottom:8px; padding:6px 12px; background: var(--primary); color:#fff; text-decoration:none; border-radius:6px; font-size: .85rem; border:1px solid var(--primary); }
        
        .download-link:hover { background: var(--primary-600); }

        /* Toasts */
        .toast { position: fixed; right: 24px; bottom: 24px; background:#111827; color:#fff; padding:12px 16px; border-radius:10px; box-shadow: var(--shadow); opacity:0; transform: translateY(8px); transition: all .2s ease; z-index: 2000; }
        .toast.show { opacity:1; transform: translateY(0); }

        /* Grid thumbs */
        .thumb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 12px; }
        .thumb-card { background:#fff; border:1px solid var(--border); border-radius: 8px; overflow:hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .thumb-card img { width: 100%; height: 120px; object-fit: cover; display:block; cursor: zoom-in; }
        .thumb-meta { padding: 8px 10px; font-size: 12px; color: #555; display:flex; justify-content: space-between; align-items:center; }
        .thumb-meta a { font-size: 12px; }

        /* Image compare slider */
        .compare { position: relative; display: inline-block; max-width: 100%; border-radius: 10px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-top: 10px; }
        .compare img { display: block; width: 100%; height: auto; user-select: none; pointer-events: none; }
        .compare .top { position: absolute; top: 0; left: 0; width: 50%; height: 100%; overflow: hidden; }
        .compare .handle { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: #667eea; box-shadow: 0 0 0 1px rgba(0,0,0,0.08); cursor: ew-resize; }
        .compare .handle::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 18px; height: 18px; border-radius: 50%; background: #667eea; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .compare .label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .compare .label.right { left: auto; right: 10px; }
        /* Grid of outputs */
        .thumb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 12px; }
        .thumb-card { background: #fff; border: 1px solid #eee; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .thumb-card img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .thumb-meta { padding: 8px 10px; font-size: 12px; color: #555; display: flex; justify-content: space-between; align-items: center; }
        .thumb-meta a { font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Image Utils</h1>
            <div class="header-actions">
                <div style="background: #fef2f2; color: #dc2626; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; border: 1px solid #fecaca; margin-right: 10px;">
                    ⚠️ React UI not built
                </div>
                <button class="btn" onclick="openCmdK()">⌘K</button>
                <button class="btn" onclick="openSettings()">Settings</button>
            </div>
        </div>

        <div style="display:flex; min-height: 60vh;">
          <aside class="sidebar" style="width: 220px; border-right:1px solid var(--border); background:#fff; padding: 12px;">
            <nav class="side-nav">
              <button class="nav-tab active" data-tab="compress" onclick="showTab('compress', this)">Compress Images</button>
              <button class="nav-tab" data-tab="split" onclick="showTab('split', this)">Split Images</button>
              <button class="nav-tab" data-tab="pdf" onclick="showTab('pdf', this)">PDF to Images</button>
              <div style="height:10px"></div>
              <button class="nav-tab" data-tab="chains" onclick="showTab('chains', this)">Tool Chains</button>
              <button class="nav-tab" data-tab="jobs" onclick="showTab('jobs', this)">Job History</button>
            </nav>
          </aside>
          <main class="content" style="flex:1;">
            <!-- Compress Tab -->
            <div id="compress-tab" class="tab-content active">
                <h2>Image Compression</h2>
                <form id="compress-form">
                    <div class="upload-area" onclick="document.getElementById('compress-files').click()">
                        <div class="upload-icon">📁</div>
                        <h3>Click to select images or drag & drop</h3>
                        <p>Supports: JPG, PNG, WebP, GIF, TIFF, AVIF</p>
                        <input type="file" id="compress-files" class="file-input" multiple accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label>Compression Level</label>
                        <select name="level">
                            <option value="medium">Medium (60% quality, 1024px width)</option>
                            <option value="high">High (40% quality, 800px width)</option>
                            <option value="extreme">Extreme (20% quality, 600px width)</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="webp" id="webp">
                            <label for="webp">Convert to WebP</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="grayscale" id="grayscale">
                            <label for="grayscale">Convert to Grayscale</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="pngOptimized" id="pngOptimized">
                            <label for="pngOptimized">PNG Optimized</label>
                        </div>
                    </div>
                    
                    <div class="file-list" id="compress-file-list"></div>
                    
                    <button type="submit" class="btn btn-primary">Compress Images</button>
                </form>
                <div id="compress-results" class="results"></div>
            </div>
            
            <!-- Split Tab -->
            <div id="split-tab" class="tab-content">
                <h2>Split Images Horizontally</h2>
                <form id="split-form">
                    <div class="upload-area" onclick="document.getElementById('split-files').click()">
                        <div class="upload-icon">✂️</div>
                        <h3>Click to select images or drag & drop</h3>
                        <p>Supports: JPG, PNG, WebP, GIF, TIFF</p>
                        <input type="file" id="split-files" class="file-input" multiple accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label>Number of Parts</label>
                        <input type="number" name="parts" value="6" min="2" max="20">
                    </div>
                    
                    <div class="form-group">
                        <label>Top Offset (pixels)</label>
                        <input type="number" name="topOffset" value="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Slice Height (pixels, 0 for auto)</label>
                        <input type="number" name="sliceHeight" value="0" min="0">
                    </div>
                    
                    <div class="file-list" id="split-file-list"></div>
                    
                    <button type="submit" class="btn btn-primary">Split Images</button>
                </form>
                <div id="split-results" class="results"></div>
            </div>
            
            <!-- PDF Tab -->
            <div id="pdf-tab" class="tab-content">
                <h2>PDF to Images</h2>
                <form id="pdf-form">
                    <div class="upload-area" onclick="document.getElementById('pdf-files').click()">
                        <div class="upload-icon">📄</div>
                        <h3>Click to select PDFs or drag & drop</h3>
                        <p>Supports: PDF files</p>
                        <input type="file" id="pdf-files" class="file-input" multiple accept=".pdf">
                    </div>
                    
                    <div class="form-group">
                        <label>Output Format</label>
                        <select name="format">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                            <option value="tiff">TIFF</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>DPI Scale</label>
                        <input type="number" name="scale" value="150" min="50" max="300">
                    </div>
                    
                    <div class="file-list" id="pdf-file-list"></div>
                    
                    <button type="submit" class="btn btn-primary">Convert PDFs</button>
                </form>
                <div id="pdf-results" class="results"></div>
            </div>
            
            <!-- Chains Tab -->
            <div id="chains-tab" class="tab-content">
                <h2>Tool Chains</h2>
                <p>Create workflows that chain multiple tools together - use the output of one tool as input to the next.</p>
                
                <div class="chain-builder">
                    <h3>Create New Chain</h3>
                    <div class="form-group">
                        <label>Chain Name</label>
                        <input type="text" id="chain-name" placeholder="e.g., PDF → Split → Compress">
                    </div>
                    
                    <div id="chain-steps"></div>
                    
                    <button type="button" class="add-step" onclick="addChainStep()">+ Add Step</button>
                    
                    <div style="margin-top: 20px;">
                        <button type="button" class="btn btn-primary" onclick="saveChain()">Save Chain</button>
                    </div>
                </div>
                
                <div>
                    <h3>Existing Chains</h3>
                    <div id="chains-list"></div>
                </div>
                
                <div>
                    <h3>Execute Chain</h3>
                    <form id="chain-execute-form">
                        <div class="form-group">
                            <label>Select Chain</label>
                            <select id="chain-select">
                                <option value="">Select a chain...</option>
                            </select>
                        </div>
                        
                        <div class="upload-area" onclick="document.getElementById('chain-files').click()">
                            <div class="upload-icon">🔗</div>
                            <h3>Click to select files or drag & drop</h3>
                            <p>Supports: Images and PDFs</p>
                            <input type="file" id="chain-files" class="file-input" multiple accept="image/*,.pdf">
                        </div>
                        
                        <div class="file-list" id="chain-file-list"></div>
                        
                        <button type="submit" class="btn btn-primary">Execute Chain</button>
                    </form>
                    <div id="chain-results" class="results"></div>
                </div>
            </div>
            
            <!-- Jobs Tab -->
            <div id="jobs-tab" class="tab-content">
                <h2>Job History</h2>
                <button type="button" class="btn btn-secondary" onclick="loadJobs()" style="margin-bottom: 20px;">Refresh</button>
                <div id="jobs-list" class="jobs-list"></div>
            </div>
          </main>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="job-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJobModal()">&times;</span>
            <div id="job-details"></div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h3>Settings</h3>
            <div class="form-group">
                <label>Default Compression Level</label>
                <select id="pref-compression" >
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="extreme">Extreme</option>
                </select>
            </div>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="pref-webp">
                    <label for="pref-webp">Default: Convert to WebP</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="pref-grayscale">
                    <label for="pref-grayscale">Default: Grayscale</label>
                </div>
            </div>
            <div style="margin-top:16px">
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Command Palette -->
    <div id="cmdk" class="modal">
      <div class="modal-content" style="max-width:600px;">
        <span class="close" onclick="closeCmdK()">&times;</span>
        <input id="cmdk-input" placeholder="Type a command... (e.g., compress)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:12px;" />
        <div id="cmdk-list">
          <div class="job-item" data-cmd="compress" onclick="showTab('compress'); closeCmdK()">Open: Compress Images</div>
          <div class="job-item" data-cmd="split" onclick="showTab('split'); closeCmdK()">Open: Split Images</div>
          <div class="job-item" data-cmd="pdf" onclick="showTab('pdf'); closeCmdK()">Open: PDF to Images</div>
          <div class="job-item" data-cmd="chains" onclick="showTab('chains'); closeCmdK()">Open: Tool Chains</div>
          <div class="job-item" data-cmd="jobs" onclick="showTab('jobs'); closeCmdK()">Open: Job History</div>
          <div class="job-item" data-cmd="settings" onclick="openSettings(); closeCmdK()">Open: Settings</div>
        </div>
      </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="img-modal" class="modal">
        <div class="modal-content" style="padding:0; max-width: 90%; max-height:90%">
            <span class="close" onclick="closeImgModal()" style="position:absolute; right:16px; top:8px; z-index:2">&times;</span>
            <img id="img-modal-src" src="" alt="Preview" style="display:block; max-width:100%; max-height:90vh; border-radius: 12px;" />
        </div>
    </div>

    <script>
        let currentFiles = {};
        let chainStepCount = 0;

        // Tab switching
        function showTab(tabName, el) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            if (el) { el.classList.add('active'); }
            else {
              const btn = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
              if (btn) btn.classList.add('active');
            }
        }

        // File handling
        function setupFileInput(inputId, listId, allowedTypes) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const uploadArea = input.closest('.upload-area') || input.parentElement.querySelector('.upload-area');
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files).filter(file => {
                        return allowedTypes.some(type => file.name.toLowerCase().endsWith(type));
                    });
                    updateFileList(files, listId);
                    currentFiles[inputId] = files;
                });
            }
            
            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                updateFileList(files, listId);
                currentFiles[inputId] = files;
            });
        }

        function updateFileList(files, listId) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            
            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" onclick="removeFile('${listId}', ${index})" style="background: #dc3545; color: white; border: none; border-radius: 5px; padding: 5px 10px;">Remove</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFile(listId, index) {
            const inputId = listId.replace('-file-list', '-files');
            const files = Array.from(currentFiles[inputId] || []);
            files.splice(index, 1);
            currentFiles[inputId] = files;
            updateFileList(files, listId);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // API calls
        async function submitForm(endpoint, formData, resultElementId) {
            const resultElement = document.getElementById(resultElementId);
            resultElement.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing...</p></div>';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Processing failed');
                }
                
                displayResults(result, resultElement);
                showToast('Job completed');
            } catch (error) {
                resultElement.innerHTML = `<div class="result-item result-error">Error: ${error.message}</div>`;
                showToast('Error: ' + error.message);
            }
        }

        function displayResults(result, element) {
            let html = `<h3>Job completed! Job ID: ${result.jobId}</h3>`;
            
            result.results.forEach(item => {
                const className = item.success ? 'result-success' : 'result-error';
                html += `<div class="result-item ${className}">`;
                html += `<h4>${item.original}</h4>`;
                
                if (item.success) {
                    if (item.compressed) {
                        html += `<p>✅ Compressed: ${item.compressed}</p>`;
                        const viewUrl = item.compressedViewUrl || item.compressedUrl;
                        if (item.originalUrl && viewUrl) {
                            const cid = Math.random().toString(36).slice(2);
                            html += `
                              <div class="compare" id="compare-${cid}">
                                <img src="${item.originalUrl}" alt="Original">
                                <div class="top"><img src="${viewUrl}" alt="Compressed"></div>
                                <div class="handle"></div>
                                <span class="label">Original</span>
                                <span class="label right">Compressed</span>
                              </div>`;
                        }
                        const meta = (item.originalSizeKB && item.compressedSizeKB) ? `<div style="margin-top:8px;color:#555;font-size:0.9rem">Original: ${item.originalSizeKB} KB · Compressed: ${item.compressedSizeKB} KB · Saved: ${item.compressionRatio}%</div>` : '';
                        html += meta + `<div class="download-links"><a href="/api/download/${result.jobId}/${item.compressed}" class="download-link">Download</a></div>`;
                    } else if (item.parts) {
                        html += `<p>✅ Split into ${item.parts.length} parts</p>`;
                        if (item.partDetails && item.partDetails.length) {
                          html += '<div class="thumb-grid">';
                          item.partDetails.forEach(p => {
                            html += `<div class="thumb-card">`+
                                    `<img src="${p.viewUrl}" alt="${p.name}">`+
                                    `<div class="thumb-meta"><span>${p.sizeKB} KB</span>`+
                                    `<a href="${p.downloadUrl}" class="download-link" style="padding:4px 8px">Download</a></div>`+
                                   `</div>`;
                          });
                          html += '</div>';
                        } else {
                          html += '<div class="download-links">';
                          item.parts.forEach(part => { html += `<a href="/api/download/${result.jobId}/${part}" class="download-link">${part}</a>`; });
                          html += '</div>';
                        }
                    } else if (item.pages) {
                        html += `<p>✅ Converted to ${item.pages.length} images</p>`;
                        if (item.pageDetails && item.pageDetails.length) {
                          html += '<div class="thumb-grid">';
                          item.pageDetails.forEach(p => {
                            html += `<div class="thumb-card">`+
                                    `<img src="${p.viewUrl}" alt="${p.name}">`+
                                    `<div class="thumb-meta"><span>${p.sizeKB} KB</span>`+
                                    `<a href="${p.downloadUrl}" class="download-link" style="padding:4px 8px">Download</a></div>`+
                                   `</div>`;
                          });
                          html += '</div>';
                        } else {
                          html += '<div class="download-links">';
                          item.pages.forEach(page => { html += `<a href="/api/download/${result.jobId}/${page}" class="download-link">${page}</a>`; });
                          html += '</div>';
                        }
                    }
                } else {
                    html += `<p>❌ ${item.error}</p>`;
                }
                
                html += '</div>';
            });
            
            element.innerHTML = html;
            // Initialize compare sliders for any newly inserted elements
            document.querySelectorAll('.compare').forEach(initCompare);
        }

        // Robust drag-based compare slider
        function initCompare(container){
            const top = container.querySelector('.top');
            const handle = container.querySelector('.handle');
            if (!top || !handle) return;
            const setPos = (clientX) => {
                const rect = container.getBoundingClientRect();
                let pct = (clientX - rect.left) / rect.width;
                if (isNaN(pct)) return;
                pct = Math.max(0, Math.min(1, pct));
                const p = (pct * 100) + '%';
                top.style.width = p;
                handle.style.left = p;
            };
            const start = (e) => {
                e.preventDefault();
                const move = (ev) => setPos((ev.touches ? ev.touches[0] : ev).clientX);
                const stop = () => {
                    window.removeEventListener('mousemove', move);
                    window.removeEventListener('touchmove', move);
                    window.removeEventListener('mouseup', stop);
                    window.removeEventListener('touchend', stop);
                };
                window.addEventListener('mousemove', move);
                window.addEventListener('touchmove', move, { passive: false });
                window.addEventListener('mouseup', stop);
                window.addEventListener('touchend', stop);
                move(e);
            };
            handle.addEventListener('mousedown', start);
            handle.addEventListener('touchstart', start, { passive: false });
            container.addEventListener('click', (e) => setPos((e.touches ? e.touches[0] : e).clientX));
        }

        // Form submissions
        document.getElementById('compress-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const files = currentFiles['compress-files'] || [];
            files.forEach(file => formData.append('files', file));
            await submitForm('/api/compress', formData, 'compress-results');
        });

        document.getElementById('split-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const files = currentFiles['split-files'] || [];
            files.forEach(file => formData.append('files', file));
            await submitForm('/api/split', formData, 'split-results');
        });

        document.getElementById('pdf-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const files = currentFiles['pdf-files'] || [];
            files.forEach(file => formData.append('files', file));
            await submitForm('/api/pdf-split', formData, 'pdf-results');
        });

        // Chain management
        function addChainStep() {
            chainStepCount++;
            const stepsContainer = document.getElementById('chain-steps');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'chain-step';
            stepDiv.innerHTML = `
                <div class="step-header">
                    <div class="step-number">${chainStepCount}</div>
                    <button type="button" class="remove-step" onclick="removeChainStep(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Tool</label>
                    <select name="tool" onchange="updateStepConfig(this)">
                        <option value="">Select tool...</option>
                        <option value="compress">Image Compression</option>
                        <option value="split">Image Splitting</option>
                        <option value="pdf-split">PDF to Images</option>
                    </select>
                </div>
                <div class="step-config"></div>
            `;
            stepsContainer.appendChild(stepDiv);
        }

        function removeChainStep(button) {
            button.closest('.chain-step').remove();
        }

        function updateStepConfig(select) {
            const configDiv = select.closest('.chain-step').querySelector('.step-config');
            const tool = select.value;
            
            let configHtml = '';
            if (tool === 'compress') {
                configHtml = `
                    <div class="form-group">
                        <label>Compression Level</label>
                        <select name="compressionLevel">
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="extreme">Extreme</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="convertToWebP">
                            <label>Convert to WebP</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="grayscale">
                            <label>Grayscale</label>
                        </div>
                    </div>
                `;
            } else if (tool === 'split') {
                configHtml = `
                    <div class="form-group">
                        <label>Number of Parts</label>
                        <input type="number" name="parts" value="6" min="2" max="20">
                    </div>
                    <div class="form-group">
                        <label>Top Offset</label>
                        <input type="number" name="topOffset" value="0" min="0">
                    </div>
                `;
            } else if (tool === 'pdf-split') {
                configHtml = `
                    <div class="form-group">
                        <label>Format</label>
                        <select name="format">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>DPI Scale</label>
                        <input type="number" name="scale" value="150" min="50" max="300">
                    </div>
                `;
            }
            configDiv.innerHTML = configHtml;
        }

        async function saveChain() {
            const chainName = document.getElementById('chain-name').value;
            const steps = [];
            
            document.querySelectorAll('.chain-step').forEach((step, index) => {
                const tool = step.querySelector('select[name="tool"]').value;
                if (!tool) return;
                
                const config = {};
                const configDiv = step.querySelector('.step-config');
                
                configDiv.querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'checkbox') {
                        config[input.name] = input.checked;
                    } else {
                        config[input.name] = input.value;
                    }
                });
                
                steps.push({ tool, config });
            });
            
            if (!chainName || steps.length === 0) {
                alert('Please enter a chain name and add at least one step');
                return;
            }
            
            try {
                const response = await fetch('/api/chains', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: chainName, steps })
                });
                
                if (response.ok) {
                    alert('Chain saved successfully!');
                    loadChains();
                    document.getElementById('chain-name').value = '';
                    document.getElementById('chain-steps').innerHTML = '';
                    chainStepCount = 0;
                } else {
                    alert('Failed to save chain');
                }
            } catch (error) {
                alert('Error saving chain: ' + error.message);
            }
        }

        async function loadChains() {
            try {
                const response = await fetch('/api/chains');
                const chains = await response.json();
                
                const chainsList = document.getElementById('chains-list');
                const chainSelect = document.getElementById('chain-select');
                
                chainsList.innerHTML = '';
                chainSelect.innerHTML = '<option value="">Select a chain...</option>';
                
                chains.forEach(chain => {
                    // Add to chains list
                    const chainDiv = document.createElement('div');
                    chainDiv.className = 'job-item';
                    chainDiv.innerHTML = `
                        <div class="job-info">
                            <h4>${chain.name}</h4>
                            <div class="job-meta">${chain.steps.length} steps</div>
                        </div>
                    `;
                    chainsList.appendChild(chainDiv);
                    
                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = chain.id;
                    option.textContent = chain.name;
                    chainSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading chains:', error);
            }
        }

        document.getElementById('chain-execute-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const chainId = document.getElementById('chain-select').value;
            if (!chainId) {
                alert('Please select a chain');
                return;
            }
            
            const formData = new FormData();
            const files = currentFiles['chain-files'] || [];
            files.forEach(file => formData.append('files', file));
            
            const resultElement = document.getElementById('chain-results');
            resultElement.innerHTML = '<div class="loading"><div class="spinner"></div><p>Executing chain...</p></div>';
            
            try {
                const response = await fetch(`/api/chains/${chainId}/execute`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Chain execution failed');
                }
                
                let html = `<h3>Chain executed successfully! Execution ID: ${result.executionId}</h3>`;
                result.results.forEach((stepResult, index) => {
                    html += `<div class="result-item result-success">`;
                    html += `<h4>Step ${index + 1}: ${stepResult.tool}</h4>`;

                    if (stepResult.tool === 'compress') {
                        stepResult.results.forEach(item => {
                            if (item.success && item.originalViewUrl && item.compressedViewUrl) {
                                const cid = Math.random().toString(36).slice(2);
                                html += `
                                  <div class="compare" id="compare-${cid}">
                                    <img src="${item.originalViewUrl}" alt="Original">
                                    <div class="top"><img src="${item.compressedViewUrl}" alt="Compressed"></div>
                                    <div class="handle"></div>
                                    <span class="label">Original</span>
                                    <span class="label right">Compressed</span>
                                  </div>
                                  <div style="margin-top:8px;color:#555;font-size:0.9rem">Original: ${item.originalSizeKB} KB · Compressed: ${item.compressedSizeKB} KB · Saved: ${item.compressionRatio}%</div>`;
                            } else {
                                html += `<p>${item.original} - ${item.success ? '✅' : '❌'}</p>`;
                            }
                        });
                    } else if (stepResult.tool === 'split' || stepResult.tool === 'pdf-split') {
                        if (stepResult.webFiles && stepResult.webFiles.length) {
                            html += '<div class="thumb-grid">';
                            stepResult.webFiles.forEach(p => {
                                html += `<div class="thumb-card">`+
                                        `<img src="${p.viewUrl}" alt="${p.name}">`+
                                        `<div class="thumb-meta"><span>${p.sizeKB} KB</span>`+
                                        `</div>`+
                                       `</div>`;
                            });
                            html += '</div>';
                        } else {
                            stepResult.results.forEach(item => {
                                html += `<p>${item.original} - ${item.success ? '✅' : '❌'}</p>`;
                            });
                        }
                    } else {
                        stepResult.results.forEach(item => {
                            html += `<p>${item.original} - ${item.success ? '✅' : '❌'}</p>`;
                        });
                    }

                    html += '</div>';
                });
                
                resultElement.innerHTML = html;
                document.querySelectorAll('.compare').forEach(initCompare);
                document.querySelectorAll('.thumb-card img').forEach(img => img.addEventListener('click', ()=> openImgModal(img.src)));
            } catch (error) {
                resultElement.innerHTML = `<div class="result-item result-error">Error: ${error.message}</div>`;
            }
        });

        // Jobs management
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                
                const jobsList = document.getElementById('jobs-list');
                jobsList.innerHTML = '';
                
                jobs.forEach(job => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'job-item';
                    jobDiv.onclick = () => showJobDetails(job.id);
                    jobDiv.innerHTML = `
                        <div class="job-info">
                            <h4>${job.type.charAt(0).toUpperCase() + job.type.slice(1)} Job</h4>
                            <div class="job-meta">
                                Created: ${new Date(job.created_at).toLocaleString()}
                                ${job.completed_at ? ` | Completed: ${new Date(job.completed_at).toLocaleString()}` : ''}
                            </div>
                        </div>
                        <div class="job-status status-${job.status}">${job.status}</div>
                    `;
                    jobsList.appendChild(jobDiv);
                });
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function showJobDetails(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();
                
                let html = `
                    <h2>${job.type.charAt(0).toUpperCase() + job.type.slice(1)} Job Details</h2>
                    <p><strong>Job ID:</strong> ${job.id}</p>
                    <p><strong>Status:</strong> ${job.status}</p>
                    <p><strong>Created:</strong> ${new Date(job.created_at).toLocaleString()}</p>
                    ${job.completed_at ? `<p><strong>Completed:</strong> ${new Date(job.completed_at).toLocaleString()}</p>` : ''}
                    ${job.error_message ? `<p><strong>Error:</strong> ${job.error_message}</p>` : ''}
                    
                    <h3>Configuration</h3>
                    <pre>${JSON.stringify(job.config, null, 2)}</pre>
                    
                    <h3>Files</h3>
                `;
                
                const inputFiles = job.files.filter(f => f.type === 'input');
                const outputFiles = job.files.filter(f => f.type === 'output');
                
                if (inputFiles.length > 0) {
                    html += '<h4>Input Files</h4><ul>';
                    inputFiles.forEach(file => {
                        html += `<li>${file.original_name} (${formatFileSize(file.size)})</li>`;
                    });
                    html += '</ul>';
                }
                
                if (outputFiles.length > 0) {
                    html += '<h4>Output Files</h4><div class="download-links">';
                    outputFiles.forEach(file => {
                        html += `<a href="/api/download/${job.id}/${file.original_name}" class="download-link">${file.original_name}</a>`;
                    });
                    html += '</div>';
                }
                
                document.getElementById('job-details').innerHTML = html;
                document.getElementById('job-modal').style.display = 'block';
            } catch (error) {
                alert('Error loading job details: ' + error.message);
            }
        }

        function closeJobModal() {
            document.getElementById('job-modal').style.display = 'none';
        }

        // Settings
        function openSettings(){ document.getElementById('settings-modal').style.display = 'block'; }
        function closeSettings(){ document.getElementById('settings-modal').style.display = 'none'; }
        function saveSettings(){
            const prefs = {
                compression: document.getElementById('pref-compression').value,
                webp: document.getElementById('pref-webp').checked,
                grayscale: document.getElementById('pref-grayscale').checked
            };
            localStorage.setItem('image-utils:prefs', JSON.stringify(prefs));
            // apply to compress form defaults
            const form = document.getElementById('compress-form');
            form.querySelector('select[name="level"]').value = prefs.compression;
            form.querySelector('input[name="webp"]').checked = prefs.webp;
            form.querySelector('input[name="grayscale"]').checked = prefs.grayscale;
            closeSettings();
            showToast('Preferences saved');
        }
        function loadSettings(){
            try{
                const raw = localStorage.getItem('image-utils:prefs');
                if(!raw) return;
                const prefs = JSON.parse(raw);
                document.getElementById('pref-compression').value = prefs.compression || 'medium';
                document.getElementById('pref-webp').checked = !!prefs.webp;
                document.getElementById('pref-grayscale').checked = !!prefs.grayscale;
                // apply to form defaults
                const form = document.getElementById('compress-form');
                form.querySelector('select[name="level"]').value = prefs.compression || 'medium';
                form.querySelector('input[name="webp"]').checked = !!prefs.webp;
                form.querySelector('input[name="grayscale"]').checked = !!prefs.grayscale;
            }catch{}
        }

        // Toasts
        let toastTimer = null;
        function showToast(msg){
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(()=> t.classList.remove('show'), 2200);
        }

        function openImgModal(src){
            const m = document.getElementById('img-modal');
            document.getElementById('img-modal-src').src = src;
            m.style.display = 'block';
        }
        function closeImgModal(){ document.getElementById('img-modal').style.display = 'none'; }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setupFileInput('compress-files', 'compress-file-list', ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.tiff', '.avif']);
            setupFileInput('split-files', 'split-file-list', ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.tiff']);
            setupFileInput('pdf-files', 'pdf-file-list', ['.pdf']);
            setupFileInput('chain-files', 'chain-file-list', ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.tiff', '.pdf']);
            
            loadJobs();
            loadChains();
            document.addEventListener('click', (e)=>{
                if(e.target.matches('.thumb-card img')) openImgModal(e.target.src);
            });

            // Keyboard shortcuts
            window.addEventListener('keydown', (e)=>{
              const isMeta = e.metaKey || e.ctrlKey;
              if (isMeta && e.key.toLowerCase() === 'k') { e.preventDefault(); openCmdK(); }
              if (!isMeta) {
                if (e.key === '1') showTab('compress');
                if (e.key === '2') showTab('split');
                if (e.key === '3') showTab('pdf');
                if (e.key === '4') showTab('chains');
                if (e.key === '5') showTab('jobs');
              }
            });
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            ['job-modal','settings-modal','img-modal'].forEach(id => {
                const m = document.getElementById(id);
                if (event.target === m) m.style.display = 'none';
            });
        }

        // Command palette
        function openCmdK(){
          const m = document.getElementById('cmdk');
          m.style.display = 'block';
          const input = document.getElementById('cmdk-input');
          input.value = '';
          input.focus();
        }
        function closeCmdK(){ document.getElementById('cmdk').style.display = 'none'; }
        (function(){
          const input = document.getElementById('cmdk-input');
          if (!input) return;
          input.addEventListener('keydown', (e)=>{
            if (e.key === 'Escape') closeCmdK();
            if (e.key === 'Enter') {
              const val = input.value.toLowerCase();
              const map = { 'compress':'compress','split':'split','pdf':'pdf','chains':'chains','jobs':'jobs','settings':'settings' };
              const target = Object.keys(map).find(k => val.includes(k));
              if (target === 'settings') openSettings(); else if (target) showTab(map[target]);
              closeCmdK();
            }
          });
        })();
    </script>
</body>
</html>
